//
//  BondingCurveTests.swift
//  Code
//
//  Created by Dima Bart on 2025-10-01.
//

import Testing
@testable import Flipcash
import BigDecimal

@Suite("ExponentialCurve parity & estimator-like behaviors")
struct BondingCurveParityTests {

    private var curve = BondingCurve()

    @Test("spotPrice at S=0 equals START_PRICE (0.01)")
    func testSpotPriceAtZeroEqualsStartPrice() throws {
        var c = curve
        c.currentSupply = 0
        let price = try c.spotPrice()
        #expect(approxEqual(price, BondingCurve.startPrice, tol: BigDecimal("1e-18")))
    }

    @Test("spotPrice increases monotonically with supply")
    func testSpotPriceMonotonicity() throws {
        var prev: BigDecimal? = nil
        var c = curve
        for s in stride(from: 0, through: 2_100_000, by: 210_000) {
            c.currentSupply = s
            let p = try c.spotPrice()
            if let q = prev {
                #expect(q < p, "spotPrice must strictly increase: \(p.asString(.plain)) ≤ \(q.asString(.plain))")
            }
            prev = p
        }
    }

    @Test("costToBuy from S=0 should invert with tokensBought(forValue:)")
    func testBuyCostInverse() {
        let step = 210_000
        var c = curve

        for tokens in stride(from: 0, through: 2_100_000, by: step) {
            c.currentSupply = 0
            let cost        = c.costToBuy(tokens: tokens)
            let delta       = c.tokensBought(forValue: cost)
            
            #expect(approxEqual(delta, BigDecimal(tokens), tol: BigDecimal("1e-9")), "Inverse mismatch at tokens=\(tokens): delta=\(delta.asString(.plain)), cost=\(cost)")
        }
    }

    @Test("valueFromSelling(tokens) inverts with tokensForValueExchange(value)")
    func testSellInverse() throws {
        var c = curve
        let supplies = [
            0,
            210_000,
            2_100_000,
            10_500_000
        ]
        
        let amounts = [
            1_000,
            10_000,
            50_000,
            100_000
        ]
        
        for s in supplies {
            c.currentSupply = s
            for tokens in amounts {
                let value    = c.valueFromSelling(tokens: tokens)
                let back     = try c.tokensForValueExchange(value)
                
                #expect(approxEqual(back, BigDecimal(tokens), tol: BigDecimal("1e-9")), "Inverse mismatch at S=\(s), tokens=\(tokens): got \(back.asString(.plain))")
            }
        }
    }

    @Test("Small buy→sell round trip (local linearity)")
    func testSmallRoundTrip() throws {
        var c = curve
        c.currentSupply = 5_000_000
        
        let small = 5_000
        let cost  = c.costToBuy(tokens: small)
        
        // Given that value, estimate tokens via inverse
        let est = c.tokensBought(forValue: cost)
        #expect(approxEqual(est, BigDecimal(small), tol: BigDecimal("1e-6")), "Expected ~\(small) got \(est.asString(.plain))")

        // Now sell 'small' tokens and estimate tokens needed for that value
        let proceeds = c.valueFromSelling(tokens: small)
        let back = try c.tokensForValueExchange(proceeds)
        #expect(approxEqual(back, BigDecimal(small), tol: BigDecimal("1e-6")), "Expected ~\(small) got \(back.asString(.plain))")
    }

    // MARK: - Errors -

    @Test("tokensBought(forValue:) returns 0 for non-positive value")
    func testTokensBoughtGuard() {
        var c = curve
        c.currentSupply = 1_000_000
        #expect(c.tokensBought(forValue: BigDecimal("0")) == BigDecimal("0"))
        #expect(c.tokensBought(forValue: BigDecimal("-1")) == BigDecimal("0"))
    }

    @Test("tokensForValueExchange throws on non-positive value and over-liquidity value")
    func testTokensForValueExchangeGuards() {
        var c = curve
        c.currentSupply = 1_000_000

        // non-positive
        #expect(throws: BondingCurveError.self) {
            _ = try c.tokensForValueExchange(BigDecimal("0"))
        }
        
        #expect(throws: BondingCurveError.self) {
            _ = try c.tokensForValueExchange(BigDecimal("-0.1"))
        }

        // over-liquidity cap: value >= (ab/c) * exp(c*S)
        let eCS = BigDecimal.exp(curve.c.multiply(BigDecimal(c.currentSupply), r), r)
        let cap = curve.a.multiply(curve.b, r).divide(curve.c, r).multiply(eCS, r)
        
        // pass something ≥ cap
        #expect(throws: BondingCurveError.self) {
            _ = try c.tokensForValueExchange(cap)
        }
    }
    
    // MARK: - Curve Table -
    
    @Test func generateCurveTable() {
        let curve       = BondingCurve()
        let chart       = curve.generateChart()
        let expectation = """
        |------|----------------|----------------------------------|----------------------------|
        | %    | S              | R(S)                             | R'(S)                      |
        |------|----------------|----------------------------------|----------------------------|
        |   0% |              0 |             0.000000000000000000 |       0.010000000000000000 |
        |   1% |         210000 |          2305.861105789981716741 |       0.012022644346172763 |
        |   2% |         420000 |          5078.115904448541534215 |       0.014454397707455990 |
        |   3% |         630000 |          8411.099252572805994079 |       0.017378008287487830 |
        |   4% |         840000 |         12418.226593194221271699 |       0.020892961308530898 |
        |   5% |        1050000 |         17235.853279805856908122 |       0.025118864315081528 |
        |   6% |        1260000 |         23027.914504382097001052 |       0.030199517203999570 |
        |   7% |        1470000 |         29991.503717815899092861 |       0.036307805476981250 |
        |   8% |        1680000 |         38363.579366411852686602 |       0.043651583223976909 |
        |   9% |        1890000 |         48429.028162644133296943 |       0.052480746024923580 |
        |  10% |        2100000 |         60530.359268815480093839 |       0.063095734447947617 |
        |  11% |        2310000 |         75079.359269293032697788 |       0.075857757502823543 |
        |  12% |        2520000 |         92571.104529113929556699 |       0.091201083935466594 |
        |  13% |        2730000 |        113600.807754381922204037 |       0.109647819614156501 |
        |  14% |        2940000 |        138884.072012677856497260 |       0.131825673855430960 |
        |  15% |        3150000 |        169281.241421457206617629 |       0.158489319245841161 |
        |  16% |        3360000 |        205826.677114668877753429 |       0.190546071795978224 |
        |  17% |        3570000 |        249763.954696210035160926 |       0.229086765276334691 |
        |  18% |        3780000 |        302588.180886403942122436 |       0.275422870333253203 |
        |  19% |        3990000 |        366096.869321052536953919 |       0.331131121481876053 |
        |  20% |        4200000 |        442451.106715220081660360 |       0.398107170552592335 |
        |  21% |        4410000 |        534249.090766552218005878 |       0.478630092321495998 |
        |  22% |        4620000 |        644614.542161032792383408 |       0.575439937335718127 |
        |  23% |        4830000 |        777302.999183098464240776 |       0.691830970917128035 |
        |  24% |        5040000 |        936829.611944971009594909 |       0.831763771100402235 |
        |  25% |        5250000 |       1128622.784843532873458537 |       0.999999999997158682 |
        |  26% |        5460000 |       1359208.895421875865128519 |       1.202264434613860247 |
        |  27% |        5670000 |       1636434.375286944147258621 |       1.445439770741491996 |
        |  28% |        5880000 |       1969732.710098423570010054 |       1.737800828743845294 |
        |  29% |        6090000 |       2370445.444159426525417912 |       2.089296130847153295 |
        |  30% |        6300000 |       2852208.112819221224012495 |       2.511886431501015604 |
        |  31% |        6510000 |       3431414.235275199495542928 |       3.019951720391376165 |
        |  32% |        6720000 |       4127773.156616601092743120 |       3.630780547687808635 |
        |  33% |        6930000 |       4964980.721473817637302993 |       4.365158322385287905 |
        |  34% |        7140000 |       5971525.601094185733889334 |       5.248074602477446309 |
        |  35% |        7350000 |       7181658.711707881980039127 |       6.309573444776833861 |
        |  36% |        7560000 |       8636558.711751503334078366 |       7.585775750260800335 |
        |  37% |        7770000 |      10385733.237728622971381967 |       9.120108393520745772 |
        |  38% |        7980000 |      12488703.560249446923460781 |      10.964781961384495109 |
        |  39% |        8190000 |      15017029.986071856446892154 |      13.182567385505639500 |
        |  40% |        8400000 |      18056746.926941154504374813 |      15.848931924539083407 |
        |  41% |        8610000 |      21711290.496251937714670876 |      19.054607179543681291 |
        |  42% |        8820000 |      26105018.254393569257809802 |      22.908676527568377074 |
        |  43% |        9030000 |      31387440.873397950647178619 |      27.542287033247062492 |
        |  44% |        9240000 |      37738309.716844764974594368 |      33.113112148093518778 |
        |  45% |        9450000 |      45373733.456239824396284084 |      39.810717055146116649 |
        |  46% |        9660000 |      54553531.861346954845070854 |      47.863009232013603364 |
        |  47% |        9870000 |      65590077.000763653396236950 |      57.543993733408308994 |
        |  48% |       10080000 |      78858922.702932518907921238 |      69.183097091516228902 |
        |  49% |       10290000 |      94811583.979074446061495565 |      83.176377109803888765 |
        |  50% |       10500000 |     113990901.268876136948759050 |      99.999999999431731393 |
        |  51% |       10710000 |     137049512.326644918115343424 |     120.226443461044417145 |
        |  52% |       10920000 |     164772060.313072976366628901 |     144.543977073738496937 |
        |  53% |       11130000 |     198101893.794126216318274349 |     173.780082873890756263 |
        |  54% |       11340000 |     238173167.200112654623643062 |     208.929613084121683562 |
        |  55% |       11550000 |     286349434.065955237978335656 |     251.188643149387841028 |
        |  56% |       11760000 |     344270046.311388491355119905 |     301.995172038279537042 |
        |  57% |       11970000 |     413905938.445330789877072304 |     363.078054767749225116 |
        |  58% |       12180000 |     497626694.930814562851633088 |     436.515832237288488341 |
        |  59% |       12390000 |     598281182.892565376065494087 |     524.807460246253459708 |
        |  60% |       12600000 |     719294493.953591157326495616 |     630.957344475890604109 |
        |  61% |       12810000 |     864784493.957539902094852551 |     758.577575023924635381 |
        |  62% |       13020000 |    1039701946.554754860966466680 |     912.010839349483218772 |
        |  63% |       13230000 |    1249998978.806239724908845839 |    1096.478196135334012759 |
        |  64% |       13440000 |    1502831621.387762286662897899 |    1318.256738546818297406 |
        |  65% |       13650000 |    1806803315.473828396955742773 |    1584.893192449405075817 |
        |  66% |       13860000 |    2172257672.403868327656955914 |    1905.460717948954013891 |
        |  67% |       14070000 |    2611630448.216783062209770895 |    2290.867652750328509297 |
        |  68% |       14280000 |    3139872710.115720270468435422 |    2754.228703316880471811 |
        |  69% |       14490000 |    3774959594.458597187636763961 |    3311.311214799943223976 |
        |  70% |       14700000 |    4538501968.395933624910308455 |    3981.071705503299975055 |
        |  71% |       14910000 |    5456481808.904038351212485334 |    4786.300923187760693967 |
        |  72% |       15120000 |    6560136322.842572317670417299 |    5754.399373324480532976 |
        |  73% |       15330000 |    7887020893.055688701433598181 |    6918.309709131965426166 |
        |  74% |       15540000 |    9482287020.665348678607148190 |    8317.637710956755406565 |
        |  75% |       15750000 |   11400218749.640068217423582686 |    9999.999999914759458920 |
        |  76% |       15960000 |   13706079855.410394534040658845 |   12022.644346070280957104 |
        |  77% |       16170000 |   16478334654.045323362996753741 |   14454.397707332779430068 |
        |  78% |       16380000 |   19811318002.141177125811542283 |   17378.008287339698308991 |
        |  79% |       16590000 |   23818445342.728435232806739543 |   20892.961308352803763762 |
        |  80% |       16800000 |   28636072029.299004917799459600 |   25118.864314867412164664 |
        |  81% |       17010000 |   34428133253.825872877852034522 |   30199.517203742145761337 |
        |  82% |       17220000 |   41391722467.200316610240648796 |   36307.805476671758673686 |
        |  83% |       17430000 |   49763798115.724905759554144683 |   43651.583223604818620829 |
        |  84% |       17640000 |   59829246911.871387436463010698 |   52480.746024476228856554 |
        |  85% |       17850000 |   71930578017.939581227165486883 |   63095.734447409782207792 |
        |  86% |       18060000 |   86479578018.293116640444601793 |   75857.757502176923730634 |
        |  87% |       18270000 |  103971323277.964912041731557091 |   91201.083934689186032447 |
        |  88% |       18480000 |  125001026503.053645309419414245 |  109647.819613221851466027 |
        |  89% |       18690000 |  150284290761.134062425916299388 |  131825.673854307264484604 |
        |  90% |       18900000 |  180681460169.654303909658937153 |  158489.319244490181095970 |
        |  91% |       19110000 |  217226895862.554457946941228295 |  190546.071794353989871367 |
        |  92% |       19320000 |  261164173443.721089426115313675 |  229086.765274381931117389 |
        |  93% |       19530000 |  313988399633.464717184160484344 |  275422.870330905469440919 |
        |  94% |       19740000 |  377497088067.571957343669212017 |  331131.121479053457013283 |
        |  95% |       19950000 |  453851325461.088650581481563889 |  398107.170549198828516240 |
        |  96% |       20160000 |  545649309511.638291354049980540 |  478630.092317416105151306 |
        |  97% |       20370000 |  656014760905.178099133976302127 |  575439.937330813016653065 |
        |  98% |       20580000 |  788703217926.112720769770678930 |  691830.970911230796209502 |
        |  99% |       20790000 |  948229830686.625444668738691734 |  831763.771093312193663780 |
        | 100% |       21000000 | 1140023003583.552443559392295060 |  999999.999988634577856058 |
        |------|----------------|----------------------------------|----------------------------|
        """
        
        let cc = chart.components(separatedBy: "\n")
        let ec = expectation.components(separatedBy: "\n")
        
        #expect(cc.count == ec.count)
        if cc.count == ec.count {
            for i in 0..<cc.count {
                #expect(cc[i] == ec[i], "Bonding curve row mismatch at index: \(i)")
            }
        }
    }
}

// MARK: - Utilities

private func absBD(_ x: BigDecimal) -> BigDecimal {
    if x.signum < 0 {
        var t = x
        t.negate()
        return t
    }
    return x
}

private let r = Rounding(.toNearestOrEven, 100)

private func approxEqual(_ a: BigDecimal, _ b: BigDecimal, tol: BigDecimal = BigDecimal("1e-12")) -> Bool {
    let d = a.subtract(b, r)
    return absBD(d) <= tol
}
