# Claude Guidelines for Flipcash iOS

This file provides instructions for Claude when working on the Flipcash iOS codebase.

---

## Maintaining This Document

**Claude should proactively update this file** when discovering critical information that would prevent mistakes or save significant time in future sessions. This includes:

- New hard rules or constraints discovered through errors
- Critical patterns that aren't obvious from the code
- Module boundaries or dependencies that caused issues
- Non-obvious project conventions

**Keep this document lean.** Only add information that is:
1. Not discoverable by reading the code directly
2. Would cause errors or significant rework if unknown
3. Applies broadly across the project (not one-off edge cases)

When adding new information, place it in the appropriate existing section. Remove outdated information when it no longer applies.

---

## Plans & Analysis Records

**Record analyses and implementation plans in `.claude/plans/`** when:

- Performing deep-dive analysis of new features or RPC changes
- Planning multi-step implementations
- Documenting architectural decisions
- Investigating complex systems that span multiple files

**File naming:** `YYYY-MM-DD-<topic>.md` (e.g., `2025-11-27-swap-rpc-analysis.md`)

**Purpose:** These records allow future sessions to reference prior analysis without re-exploring the codebase. Keep them detailed but focused on actionable information.

---

## Behavior & Approach

### Working Style

- **Understand the context.** Take your time to understand how the changes _should_ fit into the complete project. Perhaps a refactor is required. Perhaps the current structure is not ideal. Take your time to indetify this.
- **Double-check your work.** Verify changes compile and don't break existing functionality.
- **Ask clarifying questions.** When requirements are ambiguous or something is unclear or can have multiple meanings, don't assume. Ask clarifying questions where needed but try to keep these as concise and as minimal as possible.

### Before Making Changes

1. Read the relevant files first - never propose changes to code you haven't read
2. Understand the existing patterns and conventions in the current file but also any related or dependant files
3. Check module boundaries (see Hard Rules below)
4. Consider impact on other parts of the codebase

### Communication

- Be direct and concise
- When uncertain, say so rather than guessing
- Provide file paths with line numbers when referencing code (e.g., `Session.swift:326`)

---

## Hard Rules (Non-Negotiable)

### Module Boundaries

**Flipcash must NEVER import CodeServices:**

```swift
// ❌ NEVER do this in Flipcash code
import CodeServices

// ✅ ALWAYS use this instead
import FlipcashCore
```

FlipcashCore re-exports necessary types. Violating this creates tight coupling with legacy code.

### Testing Framework

**Use Swift Testing, NOT XCTest:**

```swift
// ❌ WRONG
import XCTest
class MyTests: XCTestCase { ... }

// ✅ CORRECT
import Testing
@Suite struct MyTests { ... }
```

### Exhaustive Switch Statements

**Always prefer `switch` over `if case` for enums:**

```swift
// ❌ BAD: Silent failure if enum changes
guard case .sufficient(let amount) = result else {
    showError()
    return
}

// ✅ GOOD: Compiler error if enum changes
switch result {
case .sufficient(let amount):
    handleSuccess(amount)
case .insufficient(let shortfall):
    handleError(shortfall)
}
```

### Generated Files

**Never modify files generated by FlipcashGen** - changes will be overwritten. Instead, update the service files that use the generated code.

### Legacy Code

**Do not modify:**
- `Code/` - Legacy Code Wallet (inactive)
- `Flipchat/` - Legacy chat app (inactive)
- `PoolController` and pools-related code - feature is deprecated

---

## Architecture & Patterns

### Design Pattern: MVVM + Container DI

```
Container (DI)
├── Client (gRPC)
├── FlipClient (Flipcash APIs)
├── AccountManager (Keychain)
└── SessionContainer (when logged in)
    ├── Session (main state, ObservableObject)
    ├── RatesController
    ├── HistoryController
    └── Database (SQLite)
```

- **ViewModels** provide over multi-screen flows or complex navigation patterns but not necessary for standalone, self-contained, isolated screens.
- **Session** is the main state object after authentication
- **Controllers** handle business logic and data persistence

### Key Architectural Concepts

1. **Quarks** - Smallest unit of any currency (like cents for dollars)
2. **ExchangedFiat** - Wraps underlying currency + converted display value
3. **BondingCurve** - Pricing for custom currencies
4. **AccountCluster** - Manages keys per mint

---

## Technology Stack

### Required Technologies

| Technology | Version/Notes |
|------------|---------------|
| Swift | 6.1 |
| iOS Minimum | 17.0 |
| UI Framework | SwiftUI (primary), UIKit (AppDelegate, navigation) |
| Testing | Swift Testing (`import Testing`) |
| Database | SQLite via SQLite.swift |
| Networking | gRPC via grpc-swift |
| Crypto | Ed25519 via CodeCurves |

### Package Structure

```
Flipcash/          # Main app - focus here
FlipcashCore/      # Business logic, models, clients
FlipcashUI/        # UI components, theme
FlipcashAPI/       # gRPC proto definitions
CodeServices/      # Shared Solana services (don't import in Flipcash)
CodeCurves/        # Ed25519 cryptography
CodeScanner/       # C++/OpenCV circular code scanning (see below)
```

---

## CodeScanner Project

CodeScanner is a C++ library for encoding, decoding, and scanning custom circular 2D codes ("Kik Codes"). See `.claude/spec.md` for the complete technical specification.

### Quick Reference

**Location:** `CodeScanner/`

**Dependencies:**
- OpenCV 4.10.0 (~100MB XCFramework in `CodeScanner/Frameworks/`)
- ZXing Reed-Solomon subset (bundled in `src/zxing/`)

**Public API (Objective-C):**
```objc
@interface KikCodes : NSObject
+ (NSData *)encode:(NSData *)data;   // 20-byte → 35-byte
+ (NSData *)decode:(NSData *)data;   // 35-byte → 20-byte
+ (nullable NSData *)scan:(NSData *)data width:(NSInteger)width height:(NSInteger)height quality:(KikCodesScanQuality)quality;
@end
```

**Swift Usage:**
```swift
import CodeScanner

// Scanning
if let data = KikCodes.scan(yPlaneData, width: width, height: height, quality: .best) {
    let payload = KikCodes.decode(data)
    // Parse payload...
}

// Encoding
let encoded = KikCodes.encode(payloadData)  // Ready for rendering
```

**Key Files:**
- `CodeScanner/CodeScanner/Code.h` - Objective-C public interface
- `CodeScanner/CodeScanner/src/scanner.cpp` - Core OpenCV scanning (~1000 lines)
- `CodeScanner/CodeScanner/src/kikcode_encoding.cpp` - Encoding/decoding logic

**Integration:**
- Linked as embedded framework in Code.xcodeproj
- Used by `Flipcash/Core/Screens/Main/Bill/Extraction/CodeExtractor.swift`
- Used by `Flipcash/Core/Screens/Main/Bill/CashCode.Payload+Encoding.swift`

**Known Issues:**
- All C++ files compiled with `-w` to suppress warnings
- JNI files included but not used (Android artifacts)

**OpenCV 4.10.0 Upgrade (December 2025):**
- Updated from OpenCV 2.4.13.7 to 4.10.0
- API changes: `CV_*` macros → `cv::` namespace enums
- Built as XCFramework with minimal modules (core, imgproc, calib3d, features2d)

**Updating OpenCV:**
```bash
cd CodeScanner
./Scripts/build_opencv.sh --version 4.11.0  # or latest
```
See `.claude/spec.md` for detailed build documentation.

---

## Code Style & Conventions

### File Organization

- Screens go in `Flipcash/Core/Screens/`
- ViewModels are colocated with their screens
- Models go in `FlipcashCore/Sources/FlipcashCore/Models/`
- Database models go in `Flipcash/Core/Controllers/Database/Models/`

### Naming Conventions

- ViewModels: `{Screen}ViewModel` (e.g., `GiveViewModel`)
- Screens: `{Name}Screen` (e.g., `ScanScreen`)
- Controllers: `{Domain}Controller` (e.g., `RatesController`)

### Import Order

```swift
import SwiftUI       // System frameworks first
import FlipcashCore  // Then internal packages
import FlipcashUI
```

### Avoid Over-Engineering

- Don't add features beyond what was asked
- Don't add error handling for impossible scenarios
- Don't create abstractions for one-time operations
- Don't add comments to code you didn't change
- Three similar lines of code is better than a premature abstraction

---

## Testing

### Framework: Swift Testing

```swift
import Testing
@testable import Flipcash

@Suite("Session Tests")
struct SessionTests {

    @Test("Sufficient funds returns correct amount")
    func sufficientFunds() {
        // Arrange
        let session = makeTestSession()

        // Act
        let result = session.hasSufficientFunds(for: amount)

        // Assert
        #expect(result == .sufficient(amount))
    }
}
```

### Running Tests

```bash
# Run all tests
xcodebuild test -scheme Flipcash -destination 'platform=iOS Simulator,name=iPhone 16'

# Run specific test suite
xcodebuild test -scheme Flipcash -destination 'platform=iOS Simulator,name=iPhone 16' -only-testing:FlipcashTests/SessionTests
```

### Test Naming

- Use descriptive names that explain the scenario
- Format: `func testMethodName_scenario_expectedResult()` or use `@Test("description")`

---

## Git & Workflow

### Commit Messages

```
<type>: <short description>

<optional body explaining why>
```

Types: `feat`, `fix`, `refactor`, `test`, `docs`, `chore`

### Before Committing

1. Ensure code compiles: `xcodebuild build -scheme Flipcash`
2. Run tests: `xcodebuild test -scheme Flipcash -destination '...'`
3. Review changes with `git diff`

---

## Common Pitfalls

| Pitfall | Solution |
|---------|----------|
| Importing CodeServices in Flipcash | Use `import FlipcashCore` instead |
| Using XCTest | Use Swift Testing (`import Testing`) |
| Using `if case` for enums | Use exhaustive `switch` statements |
| Modifying generated proto files | Update service files instead |
| Working on pools/betting code | Feature is deprecated, ignore it |
| Adding unnecessary abstractions | Keep it simple, solve the current problem |

---

## Verification Checklist

Before completing any task:

- [ ] Code compiles without errors
- [ ] No new warnings introduced
- [ ] Tests pass (if applicable)
- [ ] Module boundaries respected (no CodeServices in Flipcash)
- [ ] Using Swift Testing, not XCTest
- [ ] Switch statements are exhaustive (no unnecessary `default` cases)
- [ ] Changes are minimal and focused on the task

---

## Quick Reference

### Key Files

```
Session & Auth:
- Flipcash/Core/Session/Session.swift
- Flipcash/Core/Session/SessionAuthenticator.swift

Multi-Currency:
- FlipcashCore/Sources/FlipcashCore/Models/Fiat.swift (Quarks)
- FlipcashCore/Sources/FlipcashCore/Models/ExchangedFiat.swift
- FlipcashCore/Sources/FlipcashCore/Models/BondingCurve.swift

Database:
- Flipcash/Core/Controllers/Database/Schema.swift
- Flipcash/Core/Controllers/Database/Database.swift
```

### Key Constants

```swift
// USDC
PublicKey.usdc // Main stablecoin mint
PublicKey.usdc.mintDecimals // 6

// Bonding Curve
BondingCurve.startPrice  // $0.01
BondingCurve.endPrice    // $1,000,000
BondingCurve.maxSupply   // 21,000,000 tokens
```

### Build Commands

```bash
# Build
xcodebuild build -scheme Flipcash -destination 'generic/platform=iOS'

# Test
xcodebuild test -scheme Flipcash -destination 'platform=iOS Simulator,name=iPhone 16'

# Clean
xcodebuild clean -scheme Flipcash
```
